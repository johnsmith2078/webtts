# Web 页面文字朗读 Chrome 插件 PRD

## 产品目标
- 让用户在任意网页上快速朗读所选或悬浮的文本段落，支持中文优先、兼容多语言。
- 提供轻量、无侵入的 UI（选区旁和悬浮旁出现一个小按钮）。

## 核心用户场景
- 学习/浏览时，选中一段文本，点击浮动按钮立即朗读。
- 阅读长文档，鼠标悬浮段落时，点击段落右侧的朗读按钮。
- 多段朗读：选中多段落后连播或逐段播。
- 暂停/继续/停止控制。

## 主要功能需求
- 选中文本触发：在选区附近显示悬浮朗读按钮；点击后朗读选区文本。
- 悬浮段落触发：鼠标在段落上停留 N 毫秒，右侧出现朗读按钮；点击后朗读该段落文本。
- 朗读控制：播放、暂停、继续、停止；显示基础进度（当前播段/总段，或简易时间）。
- 队列与多段：允许把多段加入队列；可选择“单段播”或“连播模式”。
- 语言与声音：自动检测语言；支持手动选择语言/音色/语速/音量；记忆用户偏好。
- 语速/音量设置：可在弹出页（popup）或选项页配置。
- 错误处理：朗读失败时提示（网络/TTS 限额/文本过长）；提供重试。
- 权限与隐私：仅在用户所在页面运行；不持久化页面文本；敏感页面（如密码输入框）禁用按钮。

## 非功能性需求
- 首次交互延迟低：按钮出现 <150ms；朗读启动 <500ms（取决于 TTS 响应）。
- 兼容性：Chrome ≥ 90，支持 Manifest V3。
- 资源占用：后台常驻脚本轻量，不长时间占用 CPU/内存。
- 可扩展：未来支持键盘快捷键、自动跟读高亮。

## 用户体验/交互要求
- 按钮形态：小圆形播放图标，浅色背景，悬停可见阴影；避免遮挡文本。
- 显示/消失策略：选区按钮在失焦或 3 秒无操作后消失；悬浮按钮在鼠标移出段落后 1 秒消失。
- 提示：朗读中按钮可变为暂停/停止图标；错误时显示气泡提示。
- 文本长度限制：对超长文本提示分段；默认最大 3-5k 字符。

## 技术方案概要
- 架构：Manifest V3；`service_worker` 作为后台；`content_script` 注入页面，负责 DOM 选区和悬浮按钮；`popup`/`options` 管理设置。
- 文本获取：
  - 选区：`window.getSelection()` 获取文本与 range，去除多余空白。
  - 段落悬浮：监听 `mouseover`，命中块级元素（p/div/li/article/section），读取 `innerText`。
- UI 注入：在页面内创建 shadow DOM 容器，挂载悬浮按钮，隔离样式；避免与页面 CSS 冲突。
- 朗读实现：
  - 优先：Chrome `speechSynthesis`（内置 TTS），低延迟，无需网络；检测可用 voices。
  - 备选：可配置外部 TTS API（需网络和 key）；通过 `fetch` 调用，返回音频 URL，使用 `Audio` 播放。
- 播放控制：`content_script` 控制按钮态；实际朗读在页面（`speechSynthesis`）或后台（音频流）执行；消息通信用 `chrome.runtime.sendMessage`。
- 多语言检测：简易方案：基于字符集/浏览器语言；高级方案：可选轻量语言检测库（离线优先）。
- 设置存储：`chrome.storage.sync` 保存语言、语速、音量、偏好（默认使用浏览器语言）。
- 权限：最小化，仅需 `activeTab`，必要时加 `storage`；如用远程 TTS，需目标域白名单或 `host_permissions`。

## 数据流
1. 用户选中/悬浮 → content script 捕获文本 → 显示按钮。
2. 点击按钮 → content script 发送朗读请求 → service worker（或本地 speechSynthesis）处理 → 播放音频。
3. 播放状态/错误 → message 回传 content script → 更新按钮 UI/提示。

## 边界与限制
- 无法朗读不可复制的 canvas/图片；提示用户。
- 受页面 CSP 影响：若用远程 TTS 需在后台请求，避免被页面 CSP 拦截。
- 页内已存在同类按钮或框架时，需避免样式冲突（使用 shadow DOM + 唯一前缀类名）。

## 测试要求
- 单元：文本清洗、段落识别、语言检测逻辑。
- 集成：选区/悬浮按钮出现与消失；播放/暂停/继续/停止；队列与错误提示。
- 兼容：多语言页面（中/英/混合）、长段文本、深色/浅色主题页面。
- 性能：按钮出现时间、首帧朗读延迟，朗读过程中 UI 流畅度。

## 里程碑
- M1：选区朗读 MVP（本地 speechSynthesis，浮动按钮 UI）。
- M2：悬浮段落按钮 + 队列/播放控制。
- M3：设置页（语言/语速/音量），错误提示优化。
- M4：可选外部 TTS、语言检测优化、深色模式适配。
